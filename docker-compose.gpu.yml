services:
  api:
    build:
      context: .
      dockerfile: Dockerfile.gpu.dev  # Use Dockerfile.gpu.dev for development (no COPY of api.py/models)
      # For production, use: dockerfile: Dockerfile.gpu
    ports:
      - "8000:8000"
    volumes:
      # Mount api.py for development - changes will be reflected immediately
      - ./api.py:/app/api.py
      # Mount models directory for development - allows updating models without rebuild
      - ./models:/app/models
    environment:
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    # Enable auto-reload for development (recommended when mounting api.py as volume)
    # Uncomment the line below to automatically restart server when api.py changes
    command: ["uvicorn", "api:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    # For production, remove the command line above to use CMD from Dockerfile

